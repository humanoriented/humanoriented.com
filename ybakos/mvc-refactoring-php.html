<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-us">
<head> 
<title>MVC Refactoring in PHP: Yong Joseph Bakos</title>
<meta name="author" content="Yong Bakos" >
<meta http-equiv="content-type" content="text/html;charset=utf-8" >
<meta http-equiv="Content-Style-Type" content="text/css" >
<link rel="stylesheet" type="text/css" href="/css/resume.css" >
<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" >
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
_uacct = "UA-1044655-1";
urchinTracker();
//]]>
</script>
</head>
<body id="codesample">

<h1>Sample Code</h1>
<address>
	126 W. Bayaud Ave #2<br>
	Denver, CO 80223<br>
	(303) 653 3017<br>
	<a href="mailto:ybakos@humanoriented.com" title="E-mail Yong">ybakos@humanoriented.com</a>
</address>


<h2>MVC Refactoring in PHP</h2>

<h3>The Problem</h3>
          
<p>Just about every modern approach to Web application design embraces the notion of MVC: Model, View and Controller. The result is a separation of concerns, with purposeful code grouped together logically; easier-to-read, easier-to-test, easier-to-maintain code; and most importantly, developer sanity.</p>

<p>To illustrate, here's an excerpt from a view template in PHP that really made me want to cry:</p>
<pre>
&lt;table id="showslist"&gt;
&lt;?php
foreach ($this-&gt;showsArray as $show) {
$dayLetters = substr(date('D', $show-&gt;Time), 0, 3);
$date = strtolower(date('j', $show-&gt;Time));
$time = date('g:iA', $show-&gt;Time);
$fmtPrice = htmlspecialchars($show-&gt;Price);
$html =&lt;&lt;&lt;HTML
&lt;tr class="show"&gt;
&lt;td class="showDate"&gt;&lt;h3 class="showDateLetter"&gt;{$date}&lt;/h3&gt;
&lt;p&gt;{$dayLetters}&lt;/p&gt;
&lt;/td&gt;
&lt;td class="showDescription"&gt;
&lt;div class="performers"&gt;
HTML;
$performers = $show-&gt;GetPerformerAsXPerformersShowsArray();
foreach ($performers as $performer) {
$performerName = htmlspecialchars($performer-&gt;PerformerName);
$html .=&lt;&lt;&lt;HTML
&lt;a href="performer_view.php?intId={$performer-&gt;Id}"&gt;$performerName&lt;/a&gt; &lt;img title="No Sample Available" alt="Icon: Audio" src="/img/audio-icon-16.gif"&gt;, 
HTML;
}
if(!sizeof($performers)) {
$html .= "TBD";
} else {
$html = substr($html, 0, strlen($html) - 2);
}
$venueName = htmlspecialchars($show-&gt;VenueIdObject-&gt;VenueName);
$venuePhone = htmlspecialchars($show-&gt;VenueIdObject-&gt;PhoneNumber);
$venueAddress = addslashes($show-&gt;VenueIdObject-&gt;Address);
$venueCity = addslashes($show-&gt;VenueIdObject-&gt;City);
$venueState = addslashes($show-&gt;VenueIdObject-&gt;State);
$description = htmlspecialchars($show-&gt;Description);
$firstName = htmlspecialchars($show-&gt;UserIdObject-&gt;FirstName);
$lastName = htmlspecialchars($show-&gt;UserIdObject-&gt;LastName);

$html .=&lt;&lt;&lt;HTML
&lt;/div&gt;&lt;!-- end performers div --&gt;
&lt;div class="showInfo"&gt;&lt;a href="venue_view.php?intId={$show-&gt;VenueIdObject-&gt;Id}" class="venue"&gt;{$venueName}&lt;/a&gt; &lt;a href="#" onClick="javascript:panTo('{$venueAddress}, {$venueCity} {$venueState}')"&gt;[Show Me]&lt;/a&gt;&lt;br /&gt;{$time}. {$fmtPrice} {$venuePhone} &lt;a href="shows_view.php?intId={$show-&gt;Id}"&gt;Details&lt;/a&gt;&lt;/div&gt;
&lt;div class="showDesc"&gt;{$description}&lt;/div&gt;
&lt;h3 class="showByline"&gt;posted by &lt;a href="user_view.php?intId={$show-&gt;UserIdObject-&gt;Id}"&gt;{$firstName} {$lastName}&lt;/a&gt;&lt;/h3&gt;
HTML;
echo $html;
?&gt;
&lt;/div&gt;&lt;!-- end showsdecription div --&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;!-- end shows row --&gt;
&lt;?php } ?&gt;
&lt;/table&gt;
</pre>

<p>All the above does is render a table of events as markup. If your eyes are glazing over already, I feel your pain.</p>

<h3>The Solution</h3>

<p>I did a simple one hour refactoring of the view and controller that reduced the view code to less than 1/2. Try reading it now:</p>

<pre>
&lt;table id="showslist"&gt;
&lt;?php foreach ($this-&gt;showsArray as $show) { ?&gt;
&lt;tr class="show"&gt;
  &lt;td class="showDate"&gt;&lt;?php echo $this-&gt;renderDate($show); ?&gt;&lt;/td&gt;
  &lt;td class="showDescription"&gt;
  	&lt;div class="performers"&gt;&lt;?php echo $this-&gt;renderPerformers($show); ?&gt;&lt;/div&gt;
  	&lt;div class="showInfo"&gt;
  	  &lt;?php echo $this-&gt;renderVenue($show); ?&gt;&lt;br /&gt;
  	  &lt;?php echo $this-&gt;renderTime($show); ?&gt;.
  	  &lt;?php echo $this-&gt;renderPrice($show); ?&gt;.
  	  &lt;?php echo $this-&gt;renderPhone($show); ?&gt;.
  	  &lt;?php echo $this-&gt;renderDetailsLink($show); ?&gt;
  	&lt;/div&gt;&lt;!-- /showInfo --&gt;
  	&lt;div class="showDesc"&gt;&lt;?php echo $this-&gt;renderDescription($show); ?&gt;&lt;/div&gt;
  	&lt;h3 class="showByline"&gt;posted by &lt;?php echo $this-&gt;renderPromoter($show); ?&gt;&lt;/h3&gt;
  &lt;/td&gt;
&lt;/tr&gt;&lt;!-- end shows row --&gt;
&lt;?php } // end foreach ?&gt;
&lt;/table&gt;
</pre>

<p>All the rendering code was moved to sensible functions (can you guess what renderVenue, renderTime and renderPrice do?) in the controller . Those view functions look like:</p>

<pre>
/*============= VIEW HELPERS =============*/

// Renders the date and day in the left column of the list.
protected function renderDate(Shows $s) {
    $dayLetters = htmlspecialchars(date('D', $s->Time));
    $date = htmlspecialchars(strtolower(date('j', $s->Time)));
    $html =&lt;&lt;&lt;HTML
        &lt;h3 class="showDateLetter"&gt;{$date}&lt;/h3&gt;
        &lt;p&gt;{$dayLetters}&lt;/p&gt;
    HTML;
    return $html;
}

// Renders the time of the show
protected function renderTime(Shows $s) {
    return htmlspecialchars(date('g:ia', $s->Time));
}

// Renders the venue hyperlink
protected function renderVenue(Shows $s) {...}

// Renders the performer hyperlinked list per a show
protected function renderPerformers(Shows $s) {...}

// Take an arbitrary string like $20 or 20.00 and format it the way we want
protected function renderPrice(Shows $s) {...}

...etc...
</pre>

<p>Many developers attempt to get fancy and create a custom Renderer class hierarchy. In my opinion, this always over-complicates things -- simple, well-named functions will suffice.</p>

<p>When confronted with a lot of rendering code, some developers create functions and append them to the bottom of the view file. Many developers like to move them all into 'helpers' or additional php-include files. Other frameworks like Rails encourage a similar approach. Some frameworks and platforms such as Java's JSP allows further encapsulation of view rendering code through the use of custom tags.</p>

<p>With PHP, I always take the simplest approach: if I can encapsulate the view code into a few methods I just place them in the controller.</p>

<p>Keeping the view code simple and legible saves your teammate time when they have to decipher your code and, in turn, saves a development project money. But most importantly, when you have to look at some unfamiliar code, which would you rather read?</p>

<p id="footer">Last Update: <!--#flastmod file="mvc-refactoring-php.html" --></p>
</body>
</html>
