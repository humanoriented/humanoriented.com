<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-us">
<head> 
<title>DAO (Data Access Object) De PHP: Yong Joseph Bakos</title>
<meta name="author" content="Yong Bakos" >
<meta http-equiv="content-type" content="text/html;charset=utf-8" >
<meta http-equiv="Content-Style-Type" content="text/css" >
<link rel="stylesheet" type="text/css" href="/css/resume.css" >
<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" >
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
_uacct = "UA-1044655-1";
urchinTracker();
//]]>
</script>
</head>
<body id="codesample">

<h1>Sample Code</h1>
<address>
	126 W. Bayaud Ave #2<br>
	Denver, CO 80223<br>
	(303) 653 3017<br>
	<a href="mailto:ybakos@humanoriented.com" title="E-mail Yong">ybakos@humanoriented.com</a>
</address>

<h2>DAO de PHP (no, not <a href="http://en.wikipedia.org/wiki/Tao" title="The unicode chinese character dao"> ÈÅì</a>)</h2>

<p>Here's a reliable implementation of a <a href="http://en.wikipedia.org/wiki/Data_Access_Object">Data Access Object</a> in PHP. This helps speed up prototyping database-backed Web apps and makes your developers feel the pleasure that is not writing endless <a href="http://en.wikipedia.org/wiki/Object-relational_mapping" title="Obect Relational Mapping">ORM</a> code. If your eyes are glazing over already, we're just talking about mapping database fields to object properties 'automagically,' and if I've really lost you now the rest of this is going to bore you to tears.</p>

<p>Yes, <a href="http://www.hibernate.org" title="Hibernate Persistence and ORM">Hibernate</a> is waay better (but just as boring).</p>

<h3>The Problem (Quickly)</h3>

<p>If you're tired of writing sql code like:</p>

<pre>
SELECT * FROM cars WHERE `make` = `Aston Martin` and ...
</pre>	

<p>and would rather spend your time on more important things like figuring out the application model and getting things done by your deadline, you'll want a persistence or ORM tool to keep you sane.</p>

<h3>The Solution</h3>

<p>If you want to immediately:</p>

<pre>
$cars = Car::GetAll(); // array of Car objects representing all cars in db/xml
// or
$mySweetRide = new Car('Aston Martin');
$mySweetRide->save();
// or
$userRequest = 1; // say the user wants to see a particular ride of yours
showUser(new Car($userRequest));
</pre>
<p>then just create your Car class file:</p>

<pre>
/** Car.class.php
  * The Car class serves as a DAO abstraction of the car table in the database.
  *
  * Yong Bakos 01-01-2006
**/
class Car extends DAO implements Validatable {

	protected static $table = 'entry';

	public function __construct($id) {
		parent::__construct($id, self::$table); // necessary due to PHP OOP limitations
 	}

	public function validate() {...};

}
</pre>
<p>and away you go. Here's an overview of the parent DAO class that does all the nitty-gritty:</p>
<pre>
&lt;?php
/** DAO.class.php
  * The intent of this class is to implement a parent data access object per the
  * true DAO pattern.
  * In other words, it's a simple ORM class that maps to a table.
  * Extending this class also allows the programmer to not deal with implementing
  * traditional getters and setters by hand.
  *
  * Last Update Yong Bakos 01/10/06
**/
abstract class DAO {

	protected $props; // Table fields to be represented as member variables
	protected $changedProps = array(); // A list of properties that change during the object's life
	private $table;
	private $id;

	public function save() {...}

	public function delete() {...}

	protected static function getAllByCriteria($tableName, $className, $criteria = array()) {...}

	protected static function getOneByCriteria($tableName, $className, $criteria = array()) {...}

	private function updateId($id) {...}

	private function saveToDb($id, $table, array $data) {...}

	private function prepSqlUpdate($id, $table, array $data) {...}

	private function prepSqlInsert($id, $table, array $data) {...}

	private function deleteFromDb($id, $table) {...}

	private function clearProperties(array $properties) {...}

	private function getPropertiesFromDb($id, $table) {...}

	private function getFieldsFromDb($id, $table) {...}

	private static function chopLastAnd($sql) {...}

	private static function chopLastComma($sql) {...}

	public function __construct($idOrProperties, $table) {...}

	private function __get($propName) {...}

	function __destroy() {...}

	public function __toString() {...}

	public function init(array $properties) {...}

}
?&gt;
</pre>

<p>And here's the full implementation in all its courier glory:</p>
<pre>
&lt;?php
/** DAO.class.php
  * The intent of this class is to implement a parent data access object pattern.
  * In other words, it's a simple ORM class that maps to a table.
  * Extending this class allows the programmer to not deal with implementing
  * traditional getters and setters.
  *
  * Last Update Yong Bakos 01/10/07
**/
abstract class DAO {

	protected $props; // Table fields to be represented as member variables
	protected $changedProps = array();
	private $table;
	private $id;

	public function save() {
		if (sizeof($this->changedProps)) {
			$newId = $this->saveToDb($this->id, $this->table, $this->changedProps);
			$this->changedProps = array();
		} else return true;
		if ($this->id == 0 && $newId) {
			$this->updateId($newId);
		}
		return $this->id;
	}

	public function delete() {
		if ($this->id > 0) {
			$retVal = $this->deleteFromDb($this->id, $this->table) &&
			$this->clearProperties($this->props);
		} else if ($this->id = 0) return true;
		return false;
	}

	private function updateId($id) {
		$this->id = $id;
		$this->props['id'] = $id;
	}

	private function saveToDb($id, $table, array $data) {
   		$DB = DB::getInstance(); // DB is a singleton custom database wrapper
		if ($id == 0) {
			$sql = $this->prepSqlInsert($id, $table, $data);
		} else {
			$sql = $this->prepSqlUpdate($id, $table, $data);
		}
		return $DB->insert($sql);
 	}

	private function prepSqlUpdate($id, $table, array $data) {
		$sql = "UPDATE " . $table ." SET ";
		foreach ($data as $key=>$value) {
			if ($value == "") {
				$sql .= "$key = NULL,";
			} else {
				$sql .= "$key = '" . addslashes($value) . "',";
			}
		}
   		$sql = self::chopLastComma($sql);
   		$sql .= " WHERE id='$id';";
		return $sql;
	}

	private function prepSqlInsert($id, $table, array $data) {
		$sql = "INSERT INTO " . $table ."(";
		foreach ($data as $key=>$value) {
			$sql .= "$key,";
		}
		$sql = self::chopLastComma($sql);
		$sql .= ") VALUES (";
		foreach ($data as $key => $value) {
			$sql .= "'" . addslashes($value) . "',";
		}
		$sql = self::chopLastComma($sql);
		$sql .= ");";
		return $sql;
	}

	private function deleteFromDb($id, $table) {
  		$DB = DB::getInstance();
  		$sql = "DELETE FROM " . $this->table . " WHERE id='" . $this->id . "'";
		return $DB->delete($sql);
	}

	private function clearProperties(array $properties) {
		foreach ($properties as $key=>$value) {
			$properties[$key] = '';
		}
		return true;
	}

	/** Object[] getAllByCriteria(String $tableName, String $className, String[][] $criteria)
	  * The intent of this method is to abstract the general nature of the query
	  * SELECT * FROM $tableName WHERE $fieldName = $fieldValue
	  * where $fieldName and $fieldValue are name-value pairs in $criteria.
	  * This method returns an array of $className objects.
	**/
	protected static function getAllByCriteria($tableName, $className, $criteria = array()) {
		$all = array();
		$DB = DB::getInstance();
		$sql = "SELECT * FROM " . $tableName;
		if (sizeof($criteria) != 0) {
			$sql .= " WHERE "; 
			foreach($criteria as $key=>$value) {
				$sql .= $key . "='" . $value . "' AND ";
			}
			$sql = self::chopLastAnd($sql);
		}
		$result = $DB->select($sql);
		foreach ($result as $row) {
			$obj = new $className();
			$obj->init($row);
			$all[] = $obj;
		}
		return $all;
	}

	protected static function getOneByCriteria($tableName, $className, $criteria = array()) {
		$DB = DB::getInstance();
		$sql = "SELECT * FROM " . $tableName;
		if (sizeof($criteria) != 0) {
			$sql .= " WHERE "; 
			foreach($criteria as $key=>$value) {
				$sql .= $key . "='" . $value . "' AND ";
			}
			$sql = self::chopLastAnd($sql);
		}
		$result = $DB->select($sql);
		if(sizeof($result)) { 
			$obj = new $className();
			$obj->init($result[0]);
			return $obj;
		} else {
			return false;
		}

	}

	public function __construct($idOrProperties, $table) {
		if (is_array($idOrProperties)) { // A dangerous approach... XXX refactor
			$this->id = $idOrProperties['id'];
			$this->table = $table;
			$this->init($idOrProperties);
			array_shift($idOrProperties); // remove id from list of changed properties (id is immutable)
			$this->changedProps = $idOrProperties;
		} else if ($idOrProperties >= 0) {
			$this->id = $idOrProperties;
			$this->table = $table;
			$this->init($this->getPropertiesFromDb($idOrProperties, $table));
		} else throw new Exception('DAO constructor requires integer id or properties array');
	}

	public function init(array $properties) {
		if (is_array($properties)) {
			$this->id = $properties['id'];
			$this->props = $properties;
		} else throw new Exception('DAO init() reqiures an array');
	}

	private function getPropertiesFromDb($id, $table) {
		$DB = DB::getInstance();
		if ($id) {
			$rs =  $DB->select("SELECT * FROM " . $table . " WHERE id='" . $id . "';");
			if (sizeof($rs) == 1) {
				return $rs[0];
			} else return $this->getFieldsFromDb($id, $table);
		} else {
			return $this->getFieldsFromDb($id, $table);
		}
	}

	private function getFieldsFromDb($id, $table) {
		$DB = DB::getInstance();
		$fields = $DB->getFields($table);
		$fields['id'] = $id;
		return $fields;
	}

	private function __get($propName) {
		if (array_key_exists($propName, $this->props)) {
			return $this->props[$propName];
		} else if (method_exists($this, 'get' . $propName)) {
			return call_user_func(array($this, 'get' . $propName));
		} else throw new Exception("Invalid property name \"$propName\".");
	}

	private function __set($propName, $val) {
		if ($propName == 'id') {
			throw new Exception("Changing the id is not allowed.");
		}
		if (!array_key_exists($propName, $this->props)) {
			throw new InvalidPropertyException("Invalid property name \"$propName\".");
		}
		if ($this->props[$propName] == $val) {
			return;
		} else {
			$this->changedProps[$propName] = $val;
			$this->props[$propName] = $val;
		}
	}	

	function __destroy() {
		$this->props = null;
		$this->changedProps = null;
	}

	public function __toString() {
		$s = __CLASS__ . ":";
		foreach ($this->props as $key=>$value) {
			$s .= "$key=$value;";
		}
		return $s;
	}


	private static function chopLastAnd($sql) { // used for sql string manipulation    
		return substr($sql, 0, strlen($sql)-5);
	}

	private static function chopLastComma($sql) { // used for sql string manipulation
		return substr($sql,0,strlen($sql)-1);
	}

}
?&gt;
</pre>	

<p>If you've read this far, I'm impressed. <a href="http://en.wikipedia.org/wiki/Tao" title="The unicode chinese character dao"> ÈÅì</a></p>

<p id="footer">Last Update: <!--#flastmod file="dao-de-php.html" --></p>
</body>
</html>